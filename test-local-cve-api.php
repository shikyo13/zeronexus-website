<?php
/**
 * Test script for the local CVE database API
 */

echo "Testing Local CVE Database API\n";
echo "================================\n\n";

$baseUrl = "http://localhost:8083/api/cve-db.php";

// Test cases
$tests = [
    [
        'name' => 'Recent CVEs',
        'url' => "$baseUrl?recent=true&resultsPerPage=5",
        'expect' => 'Recent CVEs should be returned'
    ],
    [
        'name' => 'Year Filter (2025)',
        'url' => "$baseUrl?year=2025&resultsPerPage=3",
        'expect' => 'CVEs from 2025 should be returned'
    ],
    [
        'name' => 'Keyword Search',
        'url' => "$baseUrl?keyword=buffer&resultsPerPage=3",
        'expect' => 'CVEs containing buffer should be returned'
    ],
    [
        'name' => 'Severity Filter',
        'url' => "$baseUrl?severity=HIGH&resultsPerPage=3",
        'expect' => 'High severity CVEs should be returned'
    ],
    [
        'name' => 'Specific CVE',
        'url' => "$baseUrl?id=CVE-2025-6090",
        'expect' => 'Specific CVE should be returned'
    ]
];

foreach ($tests as $test) {
    echo "Test: {$test['name']}\n";
    echo "URL: {$test['url']}\n";
    
    $response = file_get_contents($test['url']);
    if ($response === false) {
        echo "❌ FAILED: Could not fetch data\n\n";
        continue;
    }
    
    $data = json_decode($response, true);
    if ($data === null) {
        echo "❌ FAILED: Invalid JSON response\n\n";
        continue;
    }
    
    if (isset($data['error'])) {
        echo "❌ FAILED: API error - {$data['message']}\n\n";
        continue;
    }
    
    $totalResults = $data['totalResults'] ?? 0;
    $resultCount = count($data['vulnerabilities'] ?? []);
    
    echo "✅ SUCCESS: {$totalResults} total results, {$resultCount} returned\n";
    
    if ($resultCount > 0) {
        $firstCve = $data['vulnerabilities'][0]['cve'] ?? [];
        $cveId = $firstCve['id'] ?? 'Unknown';
        $published = $firstCve['published'] ?? 'Unknown';
        echo "   Sample: {$cveId} (Published: {$published})\n";
    }
    
    echo "\n";
}

echo "API Testing Complete!\n";