<?php
/**
 * CVE Search API
 * 
 * This endpoint provides proxy access to the NVD API for CVE lookups.
 * 
 * Parameters:
 * - id: A specific CVE ID (e.g., CVE-2023-12345)
 * - year: A year to search for CVEs (e.g., 2023)
 */

// Set headers for JSON response
header('Content-Type: application/json');

// Enable CORS
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Exit on OPTIONS request (preflight)
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

// Get request parameters
$cveId = isset($_GET['id']) ? trim($_GET['id']) : null;
$year = isset($_GET['year']) ? intval($_GET['year']) : null;

// Initialize error handling
$error = null;

// Function to make HTTP requests with cURL
function makeRequest($url) {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'User-Agent: ZeroNexus-CVE-Tool/1.0'
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    if ($error) {
        throw new Exception("cURL Error: " . $error);
    }
    
    if ($httpCode !== 200) {
        throw new Exception("API returned non-200 status code: " . $httpCode);
    }
    
    return $response;
}

try {
    // Handle specific CVE ID lookup
    if ($cveId) {
        // Validate CVE ID format
        if (!preg_match('/^CVE-\d{4}-\d{4,}$/i', $cveId)) {
            throw new Exception("Invalid CVE ID format. Please use format: CVE-YYYY-NNNNN");
        }
        
        // Forward the request to the NVD API
        $apiUrl = "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=" . urlencode($cveId);
        $response = makeRequest($apiUrl);
        
        // Return the response as-is
        echo $response;
        exit;
    }
    
    // Handle year-based search
    elseif ($year) {
        // Validate year format (4 digits between 1988 and current year)
        $currentYear = intval(date('Y'));
        if ($year < 1988 || $year > $currentYear) {
            throw new Exception("Invalid year. Please enter a year between 1988 and $currentYear.");
        }
        
        // Create date range for the entire year
        $startDate = $year . "-01-01T00:00:00.000";
        $endDate = $year . "-12-31T23:59:59.999";
        
        // Forward the request to the NVD API with date range
        $apiUrl = "https://services.nvd.nist.gov/rest/json/cves/2.0?pubStartDate=" . urlencode($startDate) . 
                  "&pubEndDate=" . urlencode($endDate) . "&resultsPerPage=10";
        
        $response = makeRequest($apiUrl);
        
        // Return the response as-is
        echo $response;
        exit;
    }
    
    // No search parameters provided
    else {
        throw new Exception("Missing required parameter. Please provide either 'id' or 'year'.");
    }
} catch (Exception $e) {
    // Return error in a standardized format
    $error = [
        'error' => true,
        'message' => $e->getMessage()
    ];
    http_response_code(400);
    echo json_encode($error);
    exit;
}