<?php
// Page variables
$page_title = "CVE Vulnerability Dashboard - ZeroNexus";
$page_description = "Live dashboard displaying CVE vulnerability data with severity indicators, filtering options, and advanced search capabilities.";
$page_css = "/css/cve-dashboard.css";

// Add cache-busting timestamp to force reload of script
$version = time();
$page_js = "/js/cve-dashboard.js?v=" . $version;

// Add cache-busting meta tag to ensure browser doesn't cache the page
header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
header("Pragma: no-cache");
header("Expires: 0");
$header_title = "CVE Dashboard";

// Include header
include 'includes/header.php';
?>

<main class="dashboard-container">
  <!-- Page header -->

  <!-- Page title -->
  <div class="page-header">
    <h2>CVE Vulnerability Dashboard</h2>
    <p class="subtitle">Monitor and search CVE vulnerabilities in real-time</p>
  </div>

  <!-- Dashboard controls -->
  <div class="dashboard-controls mb-4">
    <div class="row g-3">
      <!-- Search bar -->
      <div class="col-md-6">
        <div class="input-group">
          <input
            type="text"
            id="cve-search"
            class="form-control"
            placeholder="Search by CVE ID, keyword, or vendor"
            aria-label="Search CVE"
          >
          <select class="form-select" id="search-type" style="max-width: 140px;">
            <option value="cve-id">CVE ID</option>
            <option value="keyword">Keyword</option>
            <option value="vendor">Vendor</option>
          </select>
          <button class="btn btn-primary" type="button" id="search-btn">
            <i class="fa-solid fa-search"></i>
            Search
          </button>
        </div>
      </div>
      
      <!-- Year selector -->
      <div class="col-md-3">
        <select class="form-select" id="year-filter">
          <option value="">Recent (30 Days)</option>
          <?php
            $currentYear = date('Y');
            for ($year = $currentYear; $year >= 1999; $year--) {
              echo "<option value=\"$year\">$year</option>";
            }
          ?>
        </select>
      </div>

      <!-- Severity filter -->
      <div class="col-md-2">
        <select class="form-select" id="severity-filter">
          <option value="">All Severities</option>
          <option value="CRITICAL">Critical</option>
          <option value="HIGH">High</option>
          <option value="MEDIUM">Medium</option>
          <option value="LOW">Low</option>
        </select>
      </div>

      <!-- Sort order -->
      <div class="col-md-1">
        <select class="form-select" id="sort-order">
          <option value="desc">Newest</option>
          <option value="asc">Oldest</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Source filters row -->
  <div class="mb-4">
    <div class="d-flex align-items-center mb-2">
      <span class="me-2 text-muted">Data Sources:</span>
      <div class="source-filters" id="source-filters">
        <label class="source-filter-pill nvd">
          <input type="checkbox" checked data-source="nvd">
          <span>NVD</span>
        </label>
        <label class="source-filter-pill mitre">
          <input type="checkbox" checked data-source="mitre">
          <span>MITRE</span>
        </label>
        <label class="source-filter-pill cisa">
          <input type="checkbox" checked data-source="cisa">
          <span>CISA KEV</span>
        </label>
      </div>
    </div>
    <div class="text-muted small fst-italic">
      <i class="fa-solid fa-info-circle"></i>
      Data from multiple sources is normalized and merged for comprehensive vulnerability information.
    </div>
  </div>

  <!-- Stats cards row -->
  <div class="stats-row mb-4">
    <div class="row">
      <div class="col-md-3 mb-3">
        <div class="stat-card total">
          <div class="stat-icon">
            <i class="fa-solid fa-bug fa-fw"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value" id="total-count">-</span>
            <span class="stat-label">Total CVEs</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="stat-card critical">
          <div class="stat-icon">
            <i class="fa-solid fa-radiation fa-fw"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value" id="critical-count">-</span>
            <span class="stat-label">Critical</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="stat-card high">
          <div class="stat-icon">
            <i class="fa-solid fa-triangle-exclamation fa-fw"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value" id="high-count">-</span>
            <span class="stat-label">High</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="stat-card medium">
          <div class="stat-icon">
            <i class="fa-solid fa-exclamation-circle fa-fw"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value" id="medium-count">-</span>
            <span class="stat-label">Medium/Low</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div id="loading" class="text-center" style="display: none;">
    <div class="loading-spinner"></div>
    <p class="mt-3">Loading vulnerability data...</p>
  </div>

  <!-- Error message -->
  <div id="error-message" class="error-message" style="display: none;">
    <i class="fa-solid fa-triangle-exclamation fa-2x mb-3"></i>
    <p class="mb-0">Unable to load CVE data. Please try again later.</p>
  </div>

  <!-- Results container -->
  <div id="cve-results" class="mb-4">
    <!-- Cards will be inserted here by JavaScript -->
  </div>

  <!-- Single CVE detail modal -->
  <div class="modal fade" id="cve-detail-modal" tabindex="-1" aria-labelledby="cve-detail-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="cve-detail-title">CVE Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="cve-detail-content">
          <!-- CVE details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" class="btn btn-primary" id="cve-external-link" target="_blank">View on NVD</a>
        </div>
      </div>
    </div>
  </div>
</main>

<?php 
// Include footer
include 'includes/footer.php';
?>